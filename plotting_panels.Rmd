---
title: "Plotting Panels"
---
```{r echo=FALSE}
Sys.setenv(TZ="GMT")
```

### Panel Basics

Load the xts package and some sample OHLC data. The PerformanceAnalytics 
package is loaded for functions that will be used in the examples and the
edhec dataset of EDHEC composite hedge fund style index returns.
```{r message=FALSE}
library(xts)
library(PerformanceAnalytics)

data(sample_matrix)
sample.xts <- as.xts(sample_matrix)
```

Create a basic plot and add a panel of the simple returns
```{r fig.keep='last'}
plot(sample.xts[,"Close"])
lines(Return.calculate(sample.xts[,"Close"]), type="h", on=NA)
```

Instead of calculating the returns and plotting the result, an alternative is 
to use `addPanel` which is useful for applying a function to the raw data in 
the current plot object. Note that `addPanel` accepts a function, it does not 
accept data like `lines` and `points`. The raw data in the current plot
object is passed to the first argument in `FUN`. Additional arguments to 
`FUN` are passed via dots (`...`).
```{r fig.keep='last'}
# plot the Close
plot(sample.xts[,"Close"], col="blue")

# calculate returns
addPanel(Return.calculate, method="discrete", type="h")
```

We can also create the same plot by using the `panels` argument. 
```{r fig.keep='last'}
plot(sample.xts[,"Close"], 
     panels='lines(Return.calculate(sample.xts[,"Close"]), type="h", on=NA)')
```

### Multiple Panels

Load the edhec data from PerformanceAnalytics. Here will use the first 4 
columns of the edhec returns data to demonstrate panel and small multiples
functionality.
```{r}
data(edhec)
R <- edhec[,1:4]
head(R)
```

To plot each column in a separate panel, specify `multi.panel = TRUE`. The 
default behavior is to use the same range for the y-axis for each panel.
```{r fig.keep='last'}
plot(R, multi.panel=TRUE, type="h")
```

Plot each column of data in a separate panel, setting the range of the y-axis 
for each panel based on each column of data. Note how each panel has a 
different y-axis range.
```{r fig.keep='last'}
plot(R, multi.panel=TRUE, type="h", yaxis.same=FALSE)
```

Attributes such as `col`, `lty`, and `lwd` are passed to each panel.
```{r fig.keep='last'}
plot(R, multi.panel=TRUE, col=c("black", "blue", "red", "green"), lty=1:4)
```

An important feature of `plot.xts` is that it does not use `layout` internally 
for panels. This means that `plot.xts` is "layout safe" and multiple panels can 
be plotted in a specified layout for custom plots.

Plot the returns data in a 1x2 panel.
```{r fig.keep='last'}
layout(matrix(1:2, 1, 2))
plot(R, multi.panel=2, type="h")
layout(matrix(1))
```

Plot the returns data in a 2x2 panel.
```{r fig.keep='last'}
layout(matrix(1:4, 2, 2))
plot(R, multi.panel=1, type="h")
layout(matrix(1))
```

### Custom Panels
Define a custom function to add a drawdowns panel.
```{r}
addDrawdowns <- function(main = "Drawdowns", col="black", on=NA, ...){
  # Get the current charting object (i.e. chob) and extract the data
  plot_object <- xts:::current.xts_chob()
  x <- plot_object$Env$xdata
  
  # compute the drawdowns
  dd <- PerformanceAnalytics:::Drawdowns(x)
  # simply call addSeries with the computed data 
  addSeries(dd, main=main, col=col, on=on, ...)
}
```
```{r fig.keep='last'}
plot(R[,1], type="h")
addDrawdowns()
```

Multiple panels of returns with the custom drawdowns panel.
```{r fig.keep='last'}
layout(matrix(1:4, 2, 2))
plot(R, type="h", multi.panel=1, panels="addDrawdowns()")
layout(matrix(1))
```

Another example of a custom panel function is to add a rolling Expected
Shortfall to the main panel.
```{r}
addrollingES <- function(gap=50, p=0.95, method="historical", on=1, ...){
  # Get the current charting object (i.e. chob) and extract the data
  plot_object <- xts:::current.xts_chob()
  x <- plot_object$Env$xdata
  
  # compute the rolling Expected Shortfall
  rollingES <- as.xts(apply.fromstart(x, FUN="ES", gap=gap, p=p, method=method))
  # simply call addSeries with the computed data 
  addSeries(rollingES, on=on, ...)
}
```
```{r fig.keep='last'}
plot(R[,1], type="h", main="Convertible Arbitrage Returns")
addrollingES(lty=2, col="blue", lwd=2)
addLegend("topleft", legend.names = "Historical 95% ES", 
          lty=2, lwd=2, col="blue")
```



